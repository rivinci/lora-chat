<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoRa Chat UI (ä¸»é¡Œ+å¸³è™Ÿ)</title>
  <link rel="manifest" href="manifest.json" />
  <!-- SHAâ€‘256 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <script>if("serviceWorker"in navigator){navigator.serviceWorker.register("service-worker.js").catch(console.error);}</script>
  <style>
    :root{
      /* å‹•æ…‹ä¸»é¡Œè®Šæ•¸ */
      --bg:#f0f4f8;
      --panel:#ffffff;
      --text:#333333;
      --primary:#2a6f97;
      --me:#d0f0fd;
      --me-txt:#003f5c;
      --other:#e2e2e2;
      --btn-bg:#2a6f97;
      --btn-txt:#ffffff;
      --font:"Segoe UI";
    }
    *{box-sizing:border-box;}

    /* å…¨åŸŸæ–‡å­—èˆ‡èƒŒæ™¯é¡è‰² */
    body,button,input,select,textarea,label,div,span,h1,h2,h3,h4,h5,h6{
      font-family:var(--font),sans-serif;
      color:var(--text);
      transition:color .3s ease,background .3s ease, border-color .3s ease;
    }

    /* èƒŒæ™¯è‰²è¨­å®š */
    body{margin:0;padding:10px;background:var(--bg);}    
    input,textarea,select{background:var(--panel);border:1px solid #ccc;border-radius:6px;}
    select,option{background:var(--panel);color:var(--text);} /* ä¸‹æ‹‰é¸é …ä¿æŒå°æ¯” */
    textarea::placeholder,input::placeholder{color:var(--text);opacity:.6;}

    h2{margin:.3em 0 .6em;text-align:center;color:var(--primary);user-select:none;}

    /* æŒ‰éˆ• */
    button{
      background:var(--btn-bg);
      color:var(--btn-txt);
      border:none;border-radius:6px;padding:8px 12px;font-size:1em;cursor:pointer;
      transition:background .2s ease;
    }
    button:hover{filter:brightness(1.05);} button:active{filter:brightness(.9);} 

    /* AUTH */
    #auth-area{
      max-width:420px;margin:0 auto 20px;background:var(--panel);
      padding:20px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);
      display:flex;flex-direction:column;gap:10px;
    }
    #auth-msg{text-align:center;font-size:.9em;color:#c00;min-height:1.2em;}

    /* MAIN */
    #main-ui{display:none;}
    #status{text-align:center;margin-bottom:5px;font-size:.9em;font-weight:600;}
    #top-bar{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:10px;}
    #settings{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
    label{font-size:.9em;font-weight:600;}
    #chat-box{
      border:1px solid #ccc;padding:10px;height:50vh;overflow-y:scroll;
      background:var(--panel);display:flex;flex-direction:column;gap:5px;margin-bottom:10px;
    }
    .msg{max-width:70%;padding:8px 12px;border-radius:10px;font-size:1em;white-space:pre-wrap;word-wrap:break-word;}
    .me{align-self:flex-end;background:var(--me);color:var(--me-txt);} 
    .other{align-self:flex-start;background:var(--other);color:var(--text);}    

    #input-area{display:flex;gap:5px;}
    #msg-input{flex:1;padding:8px;font-size:1em;resize:vertical;min-height:4em;max-height:12em;overflow-y:auto;}

    /* å±éšªå‹•ä½œå€ */
    #danger-zone{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
    #danger-zone button{background:#d9534f;color:#fff;}
    #user-info{font-size:.9em;text-align:center;margin-top:2px;font-weight:600;}
  </style>
</head>
<body>
  <h2>LoRa Chat (Web UI)</h2>

  <!-- AUTH -->
  <div id="auth-area">
    <input id="auth-username" placeholder="ä½¿ç”¨è€…åç¨±" autocomplete="username" />
    <input id="auth-password" type="password" placeholder="å¯†ç¢¼" autocomplete="current-password" />
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="login-btn">ç™»å…¥</button>
      <button id="register-btn">è¨»å†Š</button>
    </div>
    <div id="auth-msg"></div>
  </div>

  <!-- MAIN -->
  <div id="main-ui">
    <div id="top-bar">
      <div id="status">å°šæœªé€£æ¥è—ç‰™</div>
      <button id="connect-btn">é€£æ¥ BLE</button>
      <div id="settings">
        <label>ä¸»é¡Œï¼š
          <select id="theme-select">
            <option value="default">ç¶“å…¸æ·ºè‰²</option>
            <option value="dark">æ·±è‰²</option>
            <option value="daisy">é››èŠæ·¡é»ƒ</option>
            <option value="sky">å¤©ç©ºè—</option>
            <option value="mint">è–„è·ç¶ </option>
          </select>
        </label>
        <label>å­—é«”ï¼š
          <select id="font-select">
            <option value="Segoe UI">Segoe UI</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="serif">Serif</option>
          </select>
        </label>
      </div>
    </div>

    <div id="chat-box"></div>

    <div id="input-area">
      <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="4"></textarea>
      <button id="send-btn">å‚³é€</button>
    </div>

    <div id="user-info"></div>
    <div id="danger-zone">
      <button id="delete-account-btn">ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ</button>
      <button id="logout-btn">ç™»å‡º</button>
    </div>
  </div>

  <script>
    /* ==== å¸¸é‡ & å¿«æ· ==== */
    const K={ACC:"accounts",LOGIN:"loggedInUser",HIS:"lora-chat-history",INPUT:"lora-chat-input",THEME:"lora-chat-theme",FONT:"lora-chat-font"};
    const $=id=>document.getElementById(id);

    /* ==== ä¸»é¡Œå®šç¾© (æ–°å¢ text æ¬„ä½) ==== */
    const THEMES={
      default:{bg:"#f0f4f8",panel:"#ffffff",text:"#333",primary:"#2a6f97",me:"#d0f0fd",meTxt:"#003f5c",other:"#e2e2e2",btn:"#2a6f97",btnTxt:"#fff"},
      dark   :{bg:"#1e1e1e",panel:"#2d2d2d",text:"#e0e0e0",primary:"#81c1ff",me:"#3b78ff",meTxt:"#ffffff",other:"#555",btn:"#3b78ff",btnTxt:"#fff"},
      daisy  :{bg:"#fff9e6",panel:"#ffffff",text:"#333",primary:"#e2a000",me:"#ffe4a8",meTxt:"#924e00",other:"#e2e2e2",btn:"#e2a000",btnTxt:"#fff"},
      sky    :{bg:"#e7f3ff",panel:"#ffffff",text:"#003f5c",primary:"#2a6f97",me:"#d0f0fd",meTxt:"#003f5c",other:"#cadced",btn:"#2a6f97",btnTxt:"#fff"},
      mint   :{bg:"#eaf7ea",panel:"#ffffff",text:"#2b4f36",primary:"#2f8f5b",me:"#c6ecc6",meTxt:"#134a2f",other:"#d0d0d0",btn:"#2f8f5b",btnTxt:"#fff"}
    };

    function applyTheme(id){
      const t=THEMES[id]||THEMES.default;
      for(const k in t){document.documentElement.style.setProperty(`--${k}`,t[k]);}
      localStorage.setItem(K.THEME,id);
    }

    /* ==== åˆå§‹ ==== */
    const themeSelect=$("theme-select"),fontSelect=$("font-select");
    const savedTheme=localStorage.getItem(K.THEME)||"default";
    themeSelect.value=savedTheme;applyTheme(savedTheme);
    const savedFont=localStorage.getItem(K.FONT);
    if(savedFont){document.documentElement.style.setProperty("--font",savedFont);fontSelect.value=savedFont;}

    themeSelect.addEventListener("change",()=>applyTheme(themeSelect.value));
    fontSelect.addEventListener("change",()=>{document.documentElement.style.setProperty("--font",fontSelect.value);localStorage.setItem(K.FONT,fontSelect.value);});

    /* ==== AUTHé‚è¼¯ ==== */
    const authArea=$("auth-area"),usernameEl=$("auth-username"),passwordEl=$("auth-password"),loginBtn=$("login-btn"),registerBtn=$("register-btn"),authMsg=$("auth-msg");
    const mainUI=$("main-ui"),userInfo=$("user-info"),deleteBtn=$("delete-account-btn"),logoutBtn=$("logout-btn");
    const loadAcc=()=>JSON.parse(localStorage.getItem(K.ACC)||"[]");const saveAcc=a=>localStorage.setItem(K.ACC,JSON.stringify(a));
    const setLogin=u=>u?localStorage.setItem(K.LOGIN,u):localStorage.removeItem(K.LOGIN);const getLogin=()=>localStorage.getItem(K.LOGIN);

    function showAuth(msg=""){authArea.style.display="flex";mainUI.style.display="none";authMsg.textContent=msg;}
    function showMain(u){authArea.style.display="none";mainUI.style.display="block";userInfo.textContent=`ä½¿ç”¨è€…ï¼š${u}`;loadHistory();loadInput();}
   function register() {
      const u = usernameEl.value.trim();
      const p = passwordEl.value;
      if (!u || !p) {
        authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
        return;
      }
      const list = loadAcc();
      if (list.some(e => e.u === u)) {
        authMsg.textContent = "å¸³è™Ÿå·²å­˜åœ¨";
        return;
      }
      list.push({ u, h: sha256(p) });
      saveAcc(list);
      authMsg.textContent = "âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
      usernameEl.value = "";
      passwordEl.value = "";
    }

    function login() {
      const u = usernameEl.value.trim();
      const p = passwordEl.value;
      if (!u || !p) {
        authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
        return;
      }
      const acc = loadAcc().find(e => e.u === u);
      if (!acc || acc.h !== sha256(p)) {
        authMsg.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        return;
      }
      setLogin(u);
      showMain(u);
      usernameEl.value = "";
      passwordEl.value = "";
    }

    function logout() {
      setLogin(null);
      showAuth();
    }

    function deleteAccount() {
      if (!confirm("ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼Ÿæ­¤å‹•ä½œä¸å¯æ¢å¾©ï¼")) return;
      const u = getLogin();
      saveAcc(loadAcc().filter(e => e.u !== u));
      logout();
    }

    loginBtn.onclick = login;
    registerBtn.onclick = register;
    logoutBtn.onclick = logout;
    deleteBtn.onclick = deleteAccount;

    /* ==== æ­·å² / è¼¸å…¥æš«å­˜ ==== */
    const chatBox = $("chat-box"), msgInput = $("msg-input"), sendBtn = $("send-btn");
    function loadHistory() { const h = localStorage.getItem(K.HIS); if (h) chatBox.innerHTML = h; }
    function loadInput() { const t = localStorage.getItem(K.INPUT); if (t) msgInput.value = t; }
    function appendMsg(from, txt) {
      const div = document.createElement("div");
      div.className = "msg " + (from === "ä½ " ? "me" : "other");
      div.textContent = txt;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      localStorage.setItem(K.HIS, chatBox.innerHTML);
    }
    msgInput.addEventListener("input", () => localStorage.setItem(K.INPUT, msgInput.value));

    /* ==== é€è¨Šæ¯ (æ¨¡æ“¬) ==== */
    function mockReply(m) { setTimeout(() => appendMsg("ESP32 (æ¨¡æ“¬)", `æ”¶åˆ°ã€Œ${m}ã€`), 1000); }
    async function sendMessage() {
      const m = msgInput.value;
      if (!m.trim()) return;
      appendMsg("ä½ ", m);
      msgInput.value = "";
      localStorage.setItem(K.INPUT, "");
      mockReply(m); // çœŸå¯¦ BLE å¯æ›¿æ›é€™è¡Œ
    }
    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey && !/Mobi|Android/i.test(navigator.userAgent)) {
        e.preventDefault();
        sendMessage();
      }
    });

    /* ==== é€²å…¥é» ==== */
    (function init() {
      const u = getLogin();
      u ? showMain(u) : showAuth();
    })();
  </script>
</body>
</html>

