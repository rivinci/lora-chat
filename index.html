<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoRa Chat UI</title>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("âœ… Service Worker è¨»å†ŠæˆåŠŸ"))
        .catch(err => console.error("âŒ Service Worker è¨»å†Šå¤±æ•—:", err));
    }
  </script>
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 10px; background-color: #f0f4f8; }
    h2 { text-align: center; color: #2a6f97; }
    #status { text-align: center; margin-bottom: 5px; font-size: 0.9em; color: #333; }
    #top-bar { display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 10px; }
    #top-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #chat-box {
      border: 1px solid #ccc;
      padding: 10px;
      height: 50vh;
      overflow-y: scroll;
      background: #ffffff;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .msg {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 1em;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .me {
      align-self: flex-end;
      background-color: #d0f0fd;
      color: #003f5c;
    }
    .other {
      align-self: flex-start;
      background-color: #e2e2e2;
      color: #000;
    }
    #input-area {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    @media (min-width: 600px) {
      #input-area { flex-direction: row; }
    }
    #msg-input {
      flex: 1;
      padding: 8px;
      font-size: 1em;
      resize: vertical;
      min-height: 4em;
      max-height: 12em;
      overflow-y: auto;
      width: 100%;
    }
    #send-btn {
      padding: 8px 12px;
      font-size: 1em;
    }
    #send-btn::after { content: "\1f4e4"; margin-left: 6px; }
    #settings {
      display: flex;
      flex-direction: row;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    label { font-size: 0.9em; }
  </style>
</head>
<body>
  <h2>LoRa Chat (Web UI)</h2>
  <div id="top-bar">
    <div id="status">å°šæœªé€£æ¥è—ç‰™</div>
    <button id="connect-btn">é€£æ¥ BLE</button>

    <div id="auth-controls" style="margin-top: 10px; text-align: center;">
      <button id="gen-key-btn">ğŸ”‘ ç”¢ç”Ÿé‡‘é‘°å°</button>
      <button id="export-key-btn">â¬‡ï¸ åŒ¯å‡ºé‡‘é‘°</button>
      <input type="file" id="import-key-file" style="display: none">
      <label style="margin-left: 10px;">
        <input type="checkbox" id="anon-mode"> åŒ¿åæ¨¡å¼
      </label>
      <label style="margin-left: 10px;">
        é©—è­‰æ¨¡å¼ï¼š
        <select id="mode-select">
          <option value="full">æ¯å°é©—ç°½</option>
          <option value="cache">å¿«å–æ¨¡å¼</option>
          <option value="session">Session æ¨¡å¼</option>
        </select>
      </label>
    </div>

    <div id="settings">
      <label>é¸æ“‡å­—é«”ï¼š
        <select id="font-select">
          <option value="Segoe UI">Segoe UI</option>
          <option value="Arial">Arial</option>
          <option value="Courier New">Courier New</option>
          <option value="Noto Sans TC">Noto Sans TC</option>
          <option value="serif">Serif</option>
        </select>
      </label>
      <label>èƒŒæ™¯é¡è‰²ï¼š<input type="color" id="bg-color" value="#ffffff"></label>
    </div>

    <div id="extras" style="margin-top: 10px; text-align: center;">
      <label>
        <input type="checkbox" id="debug-toggle"> é¡¯ç¤ºå°åŒ…åŸæ–‡
      </label>
      <label style="margin-left: 10px;">
        é‡é€æ¬¡æ•¸ï¼š
        <input type="number" id="retry-count" min="0" max="5" value="0" style="width: 40px;">
      </label>
      <button id="export-log-btn" style="margin-left: 10px;">â¬‡ï¸ åŒ¯å‡ºèŠå¤©ç´€éŒ„</button>
    </div>

    <div id="stats" style="margin: 10px auto; text-align: center; font-size: 0.9em; color: #444;">
      å·²å‚³é€ï¼š0ï½œæˆåŠŸï¼š0ï½œå¤±æ•—ï¼š0ï½œé‡é€ï¼š0
    </div>
  </div>

  <div id="chat-box"></div>

  <div id="input-area">
    <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="4"></textarea>
    <button id="send-btn">å‚³é€</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tweetnacl/nacl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util/nacl-util.min.js"></script>
  <script>
    const chatBox = document.getElementById('chat-box');
    const sendBtn = document.getElementById('send-btn');
    const connectBtn = document.getElementById('connect-btn');
    const msgInput = document.getElementById('msg-input');
    const statusText = document.getElementById('status');
    const fontSelect = document.getElementById('font-select');
    const bgColorPicker = document.getElementById('bg-color');
    const retryInput = document.getElementById('retry-count');

    let bleDevice, bleServer, bleService, bleCharacteristicTX, bleCharacteristicRX, disconnectNotified = false;
    let keyPair;
    let stats = { sent: 0, success: 0, fail: 0, retry: 0 };

    function appendMsg(from, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + (from === "ä½ " ? 'me' : 'other');
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateStats(type) {
      stats[type]++;
      document.getElementById("stats").textContent =
        `å·²å‚³é€ï¼š${stats.sent}ï½œæˆåŠŸï¼š${stats.success}ï½œå¤±æ•—ï¼š${stats.fail}ï½œé‡é€ï¼š${stats.retry}`;
    }

    async function preparePayload(msg) {
      const anon = document.getElementById("anon-mode").checked;
      const mode = document.getElementById("mode-select").value;
      let payload = `:mode=${mode}\n`;
      if (anon) {
        const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(msg));
        const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        payload += `:anon ${hex}`;
      } else {
        const priv = nacl.util.decodeBase64(localStorage.getItem("key-priv"));
        const signature = nacl.sign.detached(nacl.util.decodeUTF8(msg), priv);
        const sigBase64 = nacl.util.encodeBase64(signature);
        const pubBase64 = localStorage.getItem("key-pub");
        payload += `:pub ${pubBase64}\n:sig ${sigBase64}\n:msg ${msg}`;
      }
      return payload;
    }

    async function sendMessage(retry = 0) {
      const msg = msgInput.value.trim();
      if (!msg) return;
      appendMsg("ä½ ", msg);
      msgInput.value = "";
      stats.sent++;
      try {
        const payload = await preparePayload(msg);
        const encoder = new TextEncoder();
        await bleCharacteristicTX.writeValue(encoder.encode(payload));
        updateStats('success');
      } catch (err) {
        if (retry < parseInt(retryInput.value || "0")) {
          updateStats('retry');
          setTimeout(() => sendMessage(retry + 1), 500);
        } else {
          updateStats('fail');
          appendMsg("ç³»çµ±", "âŒ å°åŒ…å‚³é€å¤±æ•—");
        }
      }
    }

    sendBtn.onclick = () => sendMessage();

    connectBtn.onclick = async () => {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'ESP32' }],
          optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
        });
        bleDevice.addEventListener('gattserverdisconnected', () => {
          statusText.textContent = "âŒ è—ç‰™å·²ä¸­æ–·";
          if (!disconnectNotified) {
            appendMsg("ç³»çµ±", "âš ï¸ è—ç‰™å·²ä¸­æ–·é€£ç·š");
            disconnectNotified = true;
          }
        });
        bleServer = await bleDevice.gatt.connect();
        bleService = await bleServer.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        bleCharacteristicTX = await bleService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
        bleCharacteristicRX = await bleService.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");
        await bleCharacteristicRX.startNotifications();
        bleCharacteristicRX.addEventListener('characteristicvaluechanged', event => {
          const value = new TextDecoder().decode(event.target.value);
          const lines = value.split('\n');
          let display = "", rssi = null;
          for (let line of lines) {
            if (line.startsWith(":msg")) display = line.replace(":msg", "").trim();
            else if (line.startsWith(":rssi")) rssi = line.replace(":rssi", "").trim();
          }
          if (rssi) display += `\nğŸ“¶ RSSI: ${rssi} dBm`;
          appendMsg("ESP32", display);
          if (document.getElementById("debug-toggle").checked) {
            appendMsg("å°åŒ…", value);
          }
        });
        await bleCharacteristicTX.writeValue(new TextEncoder().encode(":subscribed"));
        statusText.textContent = "âœ… å·²é€£æ¥ ESP32 BLE";
        disconnectNotified = false;
        appendMsg("ç³»çµ±", "âœ… å·²é€£æ¥ ESP32 BLE");
      } catch (err) {
        console.error(err);
        statusText.textContent = "âŒ è—ç‰™é€£ç·šå¤±æ•—";
        appendMsg("ç³»çµ±", "âŒ BLE é€£ç·šå¤±æ•—");
      }
    };

    document.getElementById("gen-key-btn").onclick = () => {
      keyPair = nacl.sign.keyPair();
      const pub = nacl.util.encodeBase64(keyPair.publicKey);
      const priv = nacl.util.encodeBase64(keyPair.secretKey);
      localStorage.setItem("key-pub", pub);
      localStorage.setItem("key-priv", priv);
      alert("ğŸ” é‡‘é‘°ç”¢ç”Ÿå®Œæˆ");
    };

    document.getElementById("export-key-btn").onclick = () => {
      const keyData = {
        pub: localStorage.getItem("key-pub"),
        priv: localStorage.getItem("key-priv")
      };
      const blob = new Blob([JSON.stringify(keyData, null, 2)], { type: "application/json" });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "keypair.json";
      link.click();
    };

    document.getElementById("export-log-btn").onclick = () => {
      const logs = Array.from(document.querySelectorAll('#chat-box .msg')).map(msg => msg.textContent);
      const blob = new Blob([JSON.stringify(logs, null, 2)], { type: "application/json" });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "chat-history.json";
      link.click();
    };

    fontSelect.addEventListener('change', () => {
      chatBox.style.fontFamily = fontSelect.value;
      msgInput.style.fontFamily = fontSelect.value;
    });

    bgColorPicker.addEventListener('input', () => {
      chatBox.style.backgroundColor = bgColorPicker.value;
    });
  </script>
</body>
</html>
