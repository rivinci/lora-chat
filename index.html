<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoRa Chat UI (å«å¸³è™Ÿç³»çµ±)</title>
  <link rel="manifest" href="manifest.json" />
  <!-- jsâ€‘sha256 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <script>
    // ===== Serviceâ€‘Worker =====
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("âœ… Service Worker è¨»å†ŠæˆåŠŸ"))
        .catch(err => console.error("âŒ Service Worker è¨»å†Šå¤±æ•—:", err));
    }
  </script>
  <style>
    :root {
      --bg: #f0f4f8;
      --panel: #ffffff;
      --primary: #2a6f97;
      --me: #d0f0fd;
      --me-txt: #003f5c;
      --other: #e2e2e2;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 10px;
      background: var(--bg);
    }
    h2 { text-align: center; color: var(--primary); margin: .3em 0 0.6em; }

    /* ===== AUTH ===== */
    #auth-area { max-width: 420px; margin: 0 auto 20px; background: var(--panel); padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.1); display: flex; flex-direction: column; gap: 10px; }
    #auth-area input { padding: 8px 12px; font-size: 1em; }
    #auth-area button { padding: 8px 12px; font-size: 1em; cursor: pointer; }
    #auth-msg { text-align: center; font-size: .9em; color: #c00; min-height: 1.2em; }

    /* ===== MAIN UI (éš±è—æ–¼æœªç™»å…¥) ===== */
    #main-ui { display: none; }

    #status { text-align: center; margin-bottom: 5px; font-size: .9em; color: #333; }
    #top-bar { display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 10px; }
    #top-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #chat-box {
      border: 1px solid #ccc; padding: 10px; height: 50vh; overflow-y: scroll;
      background: var(--panel); margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px;
    }
    .msg { max-width: 70%; padding: 8px 12px; border-radius: 10px; font-size: 1em; white-space: pre-wrap; word-wrap: break-word; }
    .me    { align-self: flex-end; background: var(--me);    color: var(--me-txt); }
    .other { align-self: flex-start; background: var(--other); color: #000; }
    #input-area { display: flex; gap: 5px; }
    #msg-input { flex: 1; padding: 8px; font-size: 1em; resize: vertical; min-height: 4em; max-height: 12em; overflow-y: auto; }
    #send-btn { padding: 8px 12px; font-size: 1em; cursor: pointer; }
    #send-btn::after { content: "ğŸ“¤"; margin-left: 6px; }

    #settings { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    label { font-size: .9em; }

    #user-info { font-size: .9em; text-align: center; margin-top: 2px; }
    #danger-zone { margin-top: 10px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    #danger-zone button { background: #d9534f; color: #fff; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>LoRa Chat (Web UI)</h2>

  <!-- ===== AUTH AREA ===== -->
  <div id="auth-area">
    <input id="auth-username" type="text" placeholder="ä½¿ç”¨è€…åç¨±" autocomplete="username" />
    <input id="auth-password" type="password" placeholder="å¯†ç¢¼" autocomplete="current-password" />
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button id="login-btn">ç™»å…¥</button>
      <button id="register-btn">è¨»å†Š</button>
    </div>
    <div id="auth-msg"></div>
  </div>

  <!-- ===== MAIN UI (ç™»å…¥å¾Œé¡¯ç¤º) ===== -->
  <div id="main-ui">
    <div id="top-bar">
      <div id="status">å°šæœªé€£æ¥è—ç‰™</div>
      <button id="connect-btn">é€£æ¥ BLE</button>
      <div id="settings">
        <label>é¸æ“‡å­—é«”ï¼š
          <select id="font-select">
            <option value="Segoe UI">Segoe UI</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="serif">Serif</option>
          </select>
        </label>
        <label>èƒŒæ™¯é¡è‰²ï¼š<input type="color" id="bg-color" value="#ffffff"></label>
      </div>
    </div>

    <div id="chat-box"></div>

    <div id="input-area">
      <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="4"></textarea>
      <button id="send-btn">å‚³é€</button>
    </div>

    <div id="user-info"></div>
    <div id="danger-zone">
      <button id="delete-account-btn">ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ</button>
      <button id="logout-btn">ç™»å‡º</button>
    </div>
  </div>

  <script>
    // ===== CONSTANTS =====
    const ACC_KEY   = "accounts";         // localStorage key for users array
    const LOGIN_KEY = "loggedInUser";     // current session
    const HISTORY_KEY = "lora-chat-history";
    const INPUT_KEY   = "lora-chat-input";

    // ===== DOM =====
    const authArea   = document.getElementById("auth-area");
    const usernameEl = document.getElementById("auth-username");
    const passwordEl = document.getElementById("auth-password");
    const loginBtn   = document.getElementById("login-btn");
    const registerBtn= document.getElementById("register-btn");
    const authMsg    = document.getElementById("auth-msg");

    const mainUI     = document.getElementById("main-ui");
    const userInfo   = document.getElementById("user-info");
    const deleteBtn  = document.getElementById("delete-account-btn");
    const logoutBtn  = document.getElementById("logout-btn");

    const chatBox    = document.getElementById("chat-box");
    const sendBtn    = document.getElementById("send-btn");
    const connectBtn = document.getElementById("connect-btn");
    const msgInput   = document.getElementById("msg-input");
    const statusText = document.getElementById("status");
    const fontSelect = document.getElementById("font-select");
    const bgColorPicker = document.getElementById("bg-color");

    // ===== BLE vars =====
    let bleDevice, bleServer, bleService, bleCharacteristicTX, bleCharacteristicRX;
    let disconnectNotified = false;

    // ===== Helper: load / save =====
    function loadAccounts() {
      return JSON.parse(localStorage.getItem(ACC_KEY) || "[]");
    }
    function saveAccounts(arr) {
      localStorage.setItem(ACC_KEY, JSON.stringify(arr));
    }
    function setLoggedIn(user) {
      if (user) {
        localStorage.setItem(LOGIN_KEY, user);
      } else {
        localStorage.removeItem(LOGIN_KEY);
      }
    }
    function getLoggedIn() {
      return localStorage.getItem(LOGIN_KEY);
    }

    // ===== AUTH Logic =====
    function hash(str) { return sha256(str); }

    function showAuth(msg="") {
      authArea.style.display = "flex";
      mainUI.style.display   = "none";
      authMsg.textContent = msg;
    }
    function showMain(username) {
      authArea.style.display = "none";
      mainUI.style.display   = "block";
      userInfo.textContent   = `ä½¿ç”¨è€…ï¼š${username}`;
      loadHistory();
      loadInput();
    }

    function register() {
      const u = usernameEl.value.trim();
      const p = passwordEl.value;
      if (!u || !p) { authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
      const accounts = loadAccounts();
      if (accounts.find(acc => acc.u === u)) { authMsg.textContent = "å¸³è™Ÿå·²å­˜åœ¨"; return; }
      accounts.push({ u, h: hash(p) });
      saveAccounts(accounts);
      authMsg.textContent = "âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
      usernameEl.value = passwordEl.value = "";
    }

    function login() {
      const u = usernameEl.value.trim();
      const p = passwordEl.value;
      if (!u || !p) { authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
      const accounts = loadAccounts();
      const acc = accounts.find(acc => acc.u === u);
      if (!acc || acc.h !== hash(p)) {
        authMsg.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        return;
      }
      setLoggedIn(u);
      usernameEl.value = passwordEl.value = "";
      showMain(u);
    }

    function logout() {
      setLoggedIn(null);
      showAuth();
    }

    function deleteAccount() {
      if (!confirm("ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼Ÿæ­¤å‹•ä½œä¸å¯æ¢å¾©ï¼")) return;
      const username = getLoggedIn();
      const accounts = loadAccounts().filter(acc => acc.u !== username);
      saveAccounts(accounts);
      logout();
    }

    registerBtn.onclick = register;
    loginBtn.onclick    = login;
    logoutBtn.onclick   = logout;
    deleteBtn.onclick   = deleteAccount;

    // ===== Chat / BLE =====
    function appendMsg(from, text) {
      const div = document.createElement("div");
      div.className = "msg " + (from === "ä½ " ? "me" : "other");
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      saveHistory();
    }

    function saveHistory() { localStorage.setItem(HISTORY_KEY, chatBox.innerHTML); }
    function loadHistory() { const h = localStorage.getItem(HISTORY_KEY); if (h) chatBox.innerHTML = h; }
    function saveInput()   { localStorage.setItem(INPUT_KEY, msgInput.value); }
    function loadInput()   { const t = localStorage.getItem(INPUT_KEY); if (t) msgInput.value = t; }
    msgInput.addEventListener("input", saveInput);

    function mockReply(message) { setTimeout(() => appendMsg("ESP32 (æ¨¡æ“¬)", `æ”¶åˆ°ã€Œ${message}ã€`), 1000); }

    async function sendMessage() {
      const msg = msgInput.value;
      if (!msg.trim()) return;
      appendMsg("ä½ ", msg);
      msgInput.value = "";
      saveInput();
      if (bleCharacteristicTX) {
        const encoder = new TextEncoder();
        await bleCharacteristicTX.writeValue(encoder.encode(msg));
      } else {
        mockReply(msg);
      }
    }
    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", e => {
      const mobile = /Mobi|Android/i.test(navigator.userAgent);
      if (e.key === "Enter" && !e.shiftKey && !mobile) { e.preventDefault(); sendMessage(); }
    });

    connectBtn.onclick = async () => {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({ filters:[{namePrefix:"ESP32"}], optionalServices:["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] });
        bleDevice.addEventListener("gattserverdisconnected", () => { statusText.textContent = "âŒ è—ç‰™å·²ä¸­æ–·"; if (!disconnectNotified) { appendMsg("ç³»çµ±", "âš ï¸ è—ç‰™å·²ä¸­æ–·é€£ç·š"); disconnectNotified = true; } });
        bleServer = await bleDevice.gatt.connect();
        bleService = await bleServer.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        bleCharacteristicTX = await bleService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
        bleCharacteristicRX = await bleService.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");
        await bleCharacteristicRX.startNotifications();
        bleCharacteristicRX.addEventListener("characteristicvaluechanged", e => {
          const decoder = new TextDecoder();
          appendMsg("ESP32", decoder.decode(e.target.value));
        });
        statusText.textContent = "âœ… å·²é€£æ¥ ESP32 BLE";
        disconnectNotified = false;
        appendMsg("ç³»çµ±", "âœ… å·²é€£æ¥ ESP32 BLE");
      } catch (err) {
        console.error(err);
        statusText.textContent = "âŒ è—ç‰™é€£ç·šå¤±æ•—";
        appendMsg("ç³»çµ±", "âŒ BLE é€£ç·šå¤±æ•—");
      }
    };

    fontSelect.addEventListener("change", () => { chatBox.style.fontFamily = msgInput.style.fontFamily = fontSelect.value; });
    bgColorPicker.addEventListener("input", () => { chatBox.style.backgroundColor = bgColorPicker.value; });

    // ===== INIT =====
    (function init() {
      const user = getLoggedIn();
      if (user) { showMain(user); } else { showAuth(); }
    })();
  </script>
</body>
</html>
