<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoRa Chat UI (ä¸»é¡Œ + å¸³è™Ÿ + BLE)</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <script>if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js").catch(console.error);}</script>
  <style>
    :root {
      --bg:#f0f4f8; --panel:#ffffff; --text:#333; --primary:#2a6f97;
      --me:#d0f0fd; --me-txt:#003f5c; --other:#e2e2e2;
      --btn-bg:#2a6f97; --btn-txt:#fff; --font:"Segoe UI";
    }
    * { box-sizing: border-box; }
    body, button, input, select, textarea, label, div, span, h1, h2, h3, h4, h5, h6 {
      font-family: var(--font), sans-serif;
      color: var(--text);
      transition: color .3s, background .3s, border-color .3s;
    }
    body { margin: 0; padding: 10px; background: var(--bg); }

    input, textarea, select {
      background: var(--panel); border: 1px solid #ccc; border-radius: 6px;
    }
    textarea::placeholder, input::placeholder {
      color: var(--text); opacity: .6;
    }
    h2 {
      text-align: center; margin: .3em 0 .6em; color: var(--primary);
    }
    button {
      background: var(--btn-bg); color: var(--btn-txt); border: none;
      border-radius: 6px; padding: 8px 12px; cursor: pointer;
    }
    button:hover { filter: brightness(1.05); }
    button:active { filter: brightness(.9); }

    #auth-area {
      max-width: 420px; margin: 0 auto 20px; background: var(--panel);
      padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      display: flex; flex-direction: column; gap: 10px;
    }
    #auth-msg {
      text-align: center; font-size: .9em; color: #c00; min-height: 1.2em;
    }
    #main-ui { display: none; }

    #chat-box {
      border: 1px solid #ccc; padding: 10px; height: 50vh;
      overflow-y: scroll; background: var(--panel);
      display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px;
    }
    .msg {
      max-width: 70%; padding: 8px 12px; border-radius: 10px; font-size: 1em;
      white-space: pre-wrap; word-wrap: break-word;
    }
    .me { align-self: flex-end; background: var(--me); color: var(--me-txt); }
    .other { align-self: flex-start; background: var(--other); color: var(--text); }

    #input-area {
      display: flex; gap: 5px; align-items: center; padding: 8px;
      background: var(--panel);
    }
    #msg-input {
      flex: 1; resize: none; padding: 8px; font-size: 1em;
      max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch;
    }

    @media screen and (max-width: 768px) {
      #input-area {
        position: fixed; bottom: 0; left: 0; right: 0;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      }
      #main-ui { padding-bottom: 140px; }
    }
  </style>
</head>

 


<body>
  <h2>LoRa Chat (Web UI)</h2>

  <!-- ç™»å…¥å€å¡Š -->
  <div id="auth-area">
    <input id="auth-username" placeholder="ä½¿ç”¨è€…åç¨±" />
    <input id="auth-password" type="password" placeholder="å¯†ç¢¼" />
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="login-btn">ç™»å…¥</button>
      <button id="register-btn">è¨»å†Š</button>
    </div>
    <div id="auth-msg"></div>
  </div>

  <!-- ä¸»ä»‹é¢å€å¡Š -->
  <div id="main-ui">
    <div id="top-bar">
      <!-- è—ç‰™ç‹€æ…‹ + æŒ‰éˆ•åŒåˆ—ï¼ˆæŒ‰éˆ•åœ¨å·¦ï¼‰ -->
	  <div style="display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px;">
		<button id="connect-btn">é€£æ¥ BLE</button>
		<div id="status">å°šæœªé€£æ¥è—ç‰™</div>
	</div>

	<!-- ç™»å‡º + åˆªé™¤ + ä½¿ç”¨è€…åç¨±ï¼ˆæŒ‰éˆ•åœ¨å·¦ï¼‰ -->
	<div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:5px;">
		<button id="logout-btn">ç™»å‡º</button>
		<button id="delete-account-btn">ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ</button>
		<div id="user-info">ä½¿ç”¨è€…ï¼š</div>
	</div>


      <!-- ä¸»é¡Œèˆ‡å­—é«”è¨­å®š -->
      <div id="settings">
        <label>ä¸»é¡Œï¼š
          <select id="theme-select">
            <option value="default">ç¶“å…¸æ·ºè‰²</option>
            <option value="dark">æ·±è‰²</option>
            <option value="daisy">é››èŠæ·¡é»ƒ</option>
            <option value="sky">å¤©ç©ºè—</option>
            <option value="mint">è–„è·ç¶ </option>
          </select>
        </label>
        <label>å­—é«”ï¼š
          <select id="font-select">
            <option value="Segoe UI">Segoe UI</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="serif">Serif</option>
          </select>
        </label>
      </div>
    </div>

    <!-- èŠå¤©è¨Šæ¯å€ -->
    <div id="chat-box"></div>

    <!-- è¼¸å…¥èˆ‡å‚³é€ -->
    <div id="input-area">
      <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1"></textarea>
      <button id="send-btn">å‚³é€</button>
    </div>
  </div>











 


<script>
const K = {
  ACC: "accounts",
  LOGIN: "loggedInUser",
  THEME: "lora-chat-theme",
  FONT: "lora-chat-font"
};
const $ = id => document.getElementById(id);

/* ======= ä¸»é¡Œèˆ‡å­—é«”åˆ‡æ› ======= */
const THEMES = {
  default: { bg:"#f0f4f8", panel:"#fff", text:"#333", primary:"#2a6f97", me:"#d0f0fd", meTxt:"#003f5c", other:"#e2e2e2", btn:"#2a6f97", btnTxt:"#fff" },
  dark: { bg:"#1e1e1e", panel:"#2d2d2d", text:"#e0e0e0", primary:"#81c1ff", me:"#3b78ff", meTxt:"#fff", other:"#555", btn:"#3b78ff", btnTxt:"#fff" },
  daisy: { bg:"#fff9e6", panel:"#fff", text:"#333", primary:"#e2a000", me:"#ffe4a8", meTxt:"#924e00", other:"#e2e2e2", btn:"#e2a000", btnTxt:"#fff" },
  sky: { bg:"#e7f3ff", panel:"#fff", text:"#003f5c", primary:"#2a6f97", me:"#d0f0fd", meTxt:"#003f5c", other:"#cadced", btn:"#2a6f97", btnTxt:"#fff" },
  mint: { bg:"#eaf7ea", panel:"#fff", text:"#2b4f36", primary:"#2f8f5b", me:"#c6ecc6", meTxt:"#134a2f", other:"#d0d0d0", btn:"#2f8f5b", btnTxt:"#fff" }
};
function applyTheme(id) {
  const t = THEMES[id] || THEMES.default;
  for (const k in t) {
    document.documentElement.style.setProperty(`--${k}`, t[k]);
  }
  localStorage.setItem(K.THEME, id);
}
const themeSel = $("theme-select"), fontSel = $("font-select");
applyTheme(localStorage.getItem(K.THEME) || "default");
themeSel.value = localStorage.getItem(K.THEME) || "default";
document.documentElement.style.setProperty("--font", localStorage.getItem(K.FONT) || "Segoe UI");
fontSel.value = localStorage.getItem(K.FONT) || "Segoe UI";
themeSel.onchange = () => applyTheme(themeSel.value);
fontSel.onchange = () => {
  document.documentElement.style.setProperty("--font", fontSel.value);
  localStorage.setItem(K.FONT, fontSel.value);
};

/* ======= å®‰å…¨æª¢æŸ¥ ======= */
function isLocalStorageAvailable() {
  try {
    const t = "__test__";
    localStorage.setItem(t, t);
    localStorage.removeItem(t);
    return true;
  } catch (e) {
    return false;
  }
}
if (!isLocalStorageAvailable()) {
  alert("âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ localStorageï¼Œè«‹æ›´æ›ç€è¦½å™¨æˆ–èª¿æ•´è¨­å®šã€‚");
}

/* ======= å¸³è™Ÿç™»å…¥ç³»çµ± ======= */
const authArea = $("auth-area"), mainUI = $("main-ui"), authMsg = $("auth-msg"), userInfo = $("user-info");
const usernameEl = $("auth-username"), passwordEl = $("auth-password");
const loginBtn = $("login-btn"), registerBtn = $("register-btn"), logoutBtn = $("logout-btn"), deleteBtn = $("delete-account-btn");

const loadAcc = () => JSON.parse(localStorage.getItem(K.ACC) || "[]");
const saveAcc = a => localStorage.setItem(K.ACC, JSON.stringify(a));
const setLogin = u => u ? localStorage.setItem(K.LOGIN, u) : localStorage.removeItem(K.LOGIN);
const getLogin = () => localStorage.getItem(K.LOGIN);

function showAuth(msg="") {
  authArea.style.display = "flex";
  mainUI.style.display = "none";
  authMsg.textContent = msg;
}
function showMain(u) {
  authArea.style.display = "none";
  mainUI.style.display = "block";
  userInfo.textContent = `ä½¿ç”¨è€…ï¼š${u}`;
  loadHistory(); loadInput();
}
function register() {
  const u = usernameEl.value.trim(), p = passwordEl.value;
  if (!u || !p) return authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
  const arr = loadAcc();
  if (arr.some(e => e.u === u)) return authMsg.textContent = "å¸³è™Ÿå·²å­˜åœ¨";
  arr.push({ u, h: sha256(p) });
  saveAcc(arr);
  authMsg.textContent = "âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
  usernameEl.value = passwordEl.value = "";
}
function login() {
  const u = usernameEl.value.trim(), p = passwordEl.value;
  if (!u || !p) return authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
  const acc = loadAcc().find(e => e.u === u);
  if (!acc || acc.h !== sha256(p)) return authMsg.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
  setLogin(u); showMain(u);
}
function logout() { setLogin(null); showAuth(); }
function delAcc() {
  if (!confirm("ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼Ÿ")) return;
  saveAcc(loadAcc().filter(e => e.u !== getLogin()));
  logout();
}
loginBtn.onclick = login;
registerBtn.onclick = register;
logoutBtn.onclick = logout;
deleteBtn.onclick = delAcc;

/***************************************************************************************/




/* ======= æ¯ä½ä½¿ç”¨è€…ç¨ç«‹è³‡æ–™å„²å­˜ ======= */
function getHistoryKey(u) { return `chat-history-${u}`; }
function getInputKey(u) { return `chat-input-${u}`; }

/* ======= èŠå¤©å„²å­˜èˆ‡é¡¯ç¤º ======= */
const chatBox = $("chat-box"), msgInput = $("msg-input"), sendBtn = $("send-btn");
function appendMsg(from, txt) {
  const d = document.createElement("div");
  d.className = "msg " + (from === "ä½ " ? "me" : "other");
  d.textContent = txt;
  chatBox.appendChild(d);
  chatBox.scrollTop = chatBox.scrollHeight;
  const u = getLogin();
  if (u) localStorage.setItem(getHistoryKey(u), chatBox.innerHTML);
}
function loadHistory() {
  const u = getLogin();
  if (!u) return;
  const h = localStorage.getItem(getHistoryKey(u));
  if (h) chatBox.innerHTML = h;
}
function loadInput() {
  const u = getLogin();
  if (!u) return;
  const t = localStorage.getItem(getInputKey(u));
  if (t) msgInput.value = t;
}
msgInput.oninput = () => {
  const u = getLogin();
  if (u) localStorage.setItem(getInputKey(u), msgInput.value);
};

/* ======= BLE è—ç‰™é€£ç·šåŠŸèƒ½ ======= */
let bleDevice, bleServer, bleService, bleTX, bleRX, discNotified = false;
const statusText = $("status"), connectBtn = $("connect-btn");

async function connectBLE() {
  if (!navigator.bluetooth) {
    alert("âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´è—ç‰™åŠŸèƒ½ã€‚");
    return;
  }
  try {
    bleDevice = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
    });
    bleDevice.addEventListener("gattserverdisconnected", () => {
      statusText.textContent = "âŒ è—ç‰™å·²ä¸­æ–·";
      if (!discNotified) {
        appendMsg("ç³»çµ±", "âš ï¸ è—ç‰™å·²ä¸­æ–·é€£ç·š");
        discNotified = true;
      }
    });
    bleServer = await bleDevice.gatt.connect();
    bleService = await bleServer.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
    bleTX = await bleService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
    bleRX = await bleService.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");

    await bleRX.startNotifications();
    bleRX.addEventListener("characteristicvaluechanged", e => {
      appendMsg("ESP32", new TextDecoder().decode(e.target.value));
    });

    statusText.textContent = "âœ… å·²é€£æ¥ ESP32 BLE";
    discNotified = false;
    appendMsg("ç³»çµ±", "âœ… å·²é€£æ¥ ESP32 BLE");
  } catch (err) {
    console.error(err);
    statusText.textContent = "âŒ è—ç‰™é€£ç·šå¤±æ•—";
    appendMsg("ç³»çµ±", "âŒ BLE é€£ç·šå¤±æ•—");
  }
}
connectBtn.onclick = connectBLE;

/* ======= è¨Šæ¯å‚³é€èˆ‡æ¨¡æ“¬å›è¦† ======= */
function mockReply(m) {
  setTimeout(() => appendMsg("ESP32 (æ¨¡æ“¬)", `æ”¶åˆ°ã€Œ${m}ã€`), 1000);
}
async function send() {
  const m = msgInput.value;
  if (!m.trim()) return;
  appendMsg("ä½ ", m);
  msgInput.value = "";
  const u = getLogin();
  if (u) localStorage.setItem(getInputKey(u), "");
  if (bleTX) {
    await bleTX.writeValue(new TextEncoder().encode(m));
  } else {
    mockReply(m);
  }
}
sendBtn.onclick = send;
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey && !/Mobi|Android/i.test(navigator.userAgent)) {
    e.preventDefault(); send();
  }
});

/* ======= ç•«é¢åˆå§‹åŒ– ======= */
(function () {
  const u = getLogin();
  u ? showMain(u) : showAuth();
})();

/* ======= è¼¸å…¥æ¬„ focus æ™‚è‡ªå‹•æ»¾å‹• ======= */
msgInput.addEventListener("focus", () => {
  setTimeout(() => {
    msgInput.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 300);
});
</script>
</body>
</html>
