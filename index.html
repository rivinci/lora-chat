<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoRa Chat UI (ä¸»é¡Œ + å¸³è™Ÿ + BLE)</title>
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <style>
    :root {
      --bg: #f0f4f8;
      --panel: #ffffff;
      --text: #333;
      --primary: #2a6f97;
      --me: #d0f0fd;
      --me-txt: #003f5c;
      --other: #e2e2e2;
      --btn-bg: #2a6f97;
      --btn-txt: #fff;
      --font: "Segoe UI";
    }

    * { box-sizing: border-box; }
    body, button, input, select, textarea {
      font-family: var(--font), sans-serif;
      color: var(--text);
      transition: all 0.3s;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
    }

    h2 {
      text-align: center;
      color: var(--primary);
      margin-top: 1em;
    }

    #auth-area, #main-ui {
      max-width: 480px;
      margin: 20px auto;
      padding: 20px;
      background: var(--panel);
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    #auth-area input {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .button-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      background: var(--btn-bg);
      color: var(--btn-txt);
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }

    button:hover { filter: brightness(1.05); }

    #auth-msg {
      color: red;
      text-align: center;
      font-size: 0.9em;
      min-height: 1.2em;
    }

    #top-bar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    #status, #user-info {
      font-weight: bold;
    }

    #settings {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }

    #chat-box {
      border: 1px solid #ccc;
      height: 50vh;
      overflow-y: scroll;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      background: var(--panel);
      margin-top: 15px;
    }

    .msg {
      max-width: 70%;
      padding: 10px;
      border-radius: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .me {
      align-self: flex-end;
      background: var(--me);
      color: var(--me-txt);
    }
    .other {
      align-self: flex-start;
      background: var(--other);
      color: var(--text);
    }

    #input-area {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #msg-input {
      flex: 1;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
    }

    #danger-zone {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    #danger-zone button {
      background: #d9534f;
      color: white;
    }

    @media (max-width: 768px) {
      #input-area {
        flex-direction: column;
      }
      #main-ui {
        padding-bottom: 100px;
      }
    }
  </style>
</head>
<body>
  <h2>LoRa Chat (Web UI)</h2>

  <!-- ç™»å…¥å€å¡Š -->
  <div id="auth-area">
    <input id="auth-username" placeholder="ä½¿ç”¨è€…åç¨±" />
    <input id="auth-password" type="password" placeholder="å¯†ç¢¼" />
    <div class="button-row">
      <button id="login-btn">ç™»å…¥</button>
      <button id="register-btn">è¨»å†Š</button>
    </div>
    <div id="auth-msg"></div
    <div class="button-row">
  <label style="cursor:pointer;">
    
    ğŸ“¥ åŒ¯å…¥å¸³è™Ÿ
    <input type="file" id="import-acc-login" accept=".json" style="display:none;">
  </label>
</div>
  </div>

  <!-- ä¸»ä»‹é¢å€å¡Š -->
  <div id="main-ui" style="display:none;">
    <div id="top-bar">
      <div id="status">å°šæœªé€£æ¥è—ç‰™</div>
      <div id="user-info">ä½¿ç”¨è€…ï¼š</div>
      <button id="connect-btn">é€£æ¥ BLE</button>
    </div>
    <div class="button-row" style="margin-top:15px;">
  <button id="export-acc-btn">ğŸ“¤ åŒ¯å‡ºç›®å‰å¸³è™Ÿ</button>
</div>

    <div id="settings">
      <label>ä¸»é¡Œï¼š
        <select id="theme-select">
          <option value="default">ç¶“å…¸æ·ºè‰²</option>
          <option value="dark">æ·±è‰²</option>
        </select>
      </label>
      <label>å­—é«”ï¼š
        <select id="font-select">
          <option value="Segoe UI">Segoe UI</option>
          <option value="Arial">Arial</option>
        </select>
      </label>
    </div>

    <div id="chat-box"></div>

    <div id="input-area">
      <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="3"></textarea>
      <button id="send-btn">å‚³é€</button>
    </div>

    <div id="danger-zone">
      <button id="delete-account-btn">ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ</button>
      <button id="logout-btn">ç™»å‡º</button>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const K = { ACC: "accounts", LOGIN: "loggedInUser", THEME: "lora-theme", FONT: "lora-font" };

    const THEMES = {
      default: { bg: "#f0f4f8", panel: "#fff", text: "#333", primary: "#2a6f97", me: "#d0f0fd", meTxt: "#003f5c", other: "#e2e2e2", btn: "#2a6f97", btnTxt: "#fff" },
      dark: { bg: "#1e1e1e", panel: "#2d2d2d", text: "#e0e0e0", primary: "#81c1ff", me: "#3b78ff", meTxt: "#fff", other: "#555", btn: "#3b78ff", btnTxt: "#fff" }
    };

    function applyTheme(id) {
      const t = THEMES[id] || THEMES.default;
      for (let k in t) {
        document.documentElement.style.setProperty(`--${k}`, t[k]);
      }
      localStorage.setItem(K.THEME, id);
    }

    const themeSel = $("theme-select"), fontSel = $("font-select");
    applyTheme(localStorage.getItem(K.THEME) || "default");
    themeSel.value = localStorage.getItem(K.THEME) || "default";
    fontSel.value = localStorage.getItem(K.FONT) || "Segoe UI";
    document.documentElement.style.setProperty("--font", fontSel.value);
    themeSel.onchange = () => applyTheme(themeSel.value);
    fontSel.onchange = () => {
      localStorage.setItem(K.FONT, fontSel.value);
      document.documentElement.style.setProperty("--font", fontSel.value);
    };

    const loadAcc = () => JSON.parse(localStorage.getItem(K.ACC) || "[]");
    const saveAcc = a => localStorage.setItem(K.ACC, JSON.stringify(a));
    const setLogin = u => u ? localStorage.setItem(K.LOGIN, u) : localStorage.removeItem(K.LOGIN);
    const getLogin = () => localStorage.getItem(K.LOGIN);

    const authArea = $("auth-area"), mainUI = $("main-ui"), authMsg = $("auth-msg"), userInfo = $("user-info");
    const usernameEl = $("auth-username"), passwordEl = $("auth-password");

    function showAuth(msg = "") {
      authArea.style.display = "block";
      mainUI.style.display = "none";
      authMsg.textContent = msg;
    }

    function showMain(u) {
      authArea.style.display = "none";
      mainUI.style.display = "block";
      userInfo.textContent = `ä½¿ç”¨è€…ï¼š${u}`;
      loadHistory();
    }

    function register() {
      const u = usernameEl.value.trim(), p = passwordEl.value;
      if (!u || !p) return authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
      const arr = loadAcc();
      if (arr.some(e => e.u === u)) return authMsg.textContent = "å¸³è™Ÿå·²å­˜åœ¨";
      arr.push({ u, h: sha256(p) });
      saveAcc(arr);
      authMsg.textContent = "âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
      usernameEl.value = passwordEl.value = "";
    }

    function login() {
      const u = usernameEl.value.trim(), p = passwordEl.value;
      if (!u || !p) return authMsg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
      const acc = loadAcc().find(e => e.u === u);
      if (!acc || acc.h !== sha256(p)) return authMsg.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
      setLogin(u); showMain(u);
    }

    function logout() {
      setLogin(null);
      showAuth();
    }

    function delAcc() {
      if (!confirm("ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼Ÿ")) return;
      saveAcc(loadAcc().filter(e => e.u !== getLogin()));
      logout();
    }

    $("login-btn").onclick = login;
    $("register-btn").onclick = register;
    $("logout-btn").onclick = logout;
    $("delete-account-btn").onclick = delAcc;

    const chatBox = $("chat-box"), msgInput = $("msg-input"), sendBtn = $("send-btn");

    function appendMsg(from, txt) {
      const d = document.createElement("div");
      d.className = "msg " + (from === "ä½ " ? "me" : "other");
      d.textContent = txt;
      chatBox.appendChild(d);
      chatBox.scrollTop = chatBox.scrollHeight;
      const u = getLogin();
      if (u) localStorage.setItem("chat-history-" + u, chatBox.innerHTML);
    }

    function loadHistory() {
      const u = getLogin();
      if (!u) return;
      chatBox.innerHTML = localStorage.getItem("chat-history-" + u) || "";
    }

    function send() {
      const msg = msgInput.value.trim();
      if (!msg) return;
      appendMsg("ä½ ", msg);
      msgInput.value = "";
      mockReply(msg);
    }

    sendBtn.onclick = send;
    msgInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    function mockReply(m) {
      setTimeout(() => appendMsg("ESP32", `æ”¶åˆ°ã€Œ${m}ã€`), 1000);
    }

    (function () {
      const u = getLogin();
      u ? showMain(u) : showAuth();
    })();
    function handleAccountImport(file) {
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const imported = JSON.parse(evt.target.result);
      if (!Array.isArray(imported)) throw "æ ¼å¼éŒ¯èª¤";
      const current = loadAcc();
      const merged = [...current];
      imported.forEach(newAcc => {
        const i = current.findIndex(e => e.u === newAcc.u);
        if (i >= 0) {
          if (confirm(`å¸³è™Ÿ ${newAcc.u} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`)) {
            merged[i] = newAcc;
          }
        } else {
          merged.push(newAcc);
        }
      });
      saveAcc(merged);
      alert("âœ… åŒ¯å…¥å®Œæˆï¼");
    } catch (err) {
      alert("âŒ åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢ºï¼");
    }
  };
  reader.readAsText(file);
}

$("import-acc-login").addEventListener("change", e => {
  const file = e.target.files[0];
  if (file) handleAccountImport(file);
});
$("export-acc-btn").addEventListener("click", () => {
  const currentUser = getLogin();
  if (!currentUser) return alert("âš ï¸ æœªç™»å…¥ï¼Œç„¡æ³•åŒ¯å‡ºå¸³è™Ÿã€‚");

  const accList = loadAcc();
  const account = accList.find(acc => acc.u === currentUser);
  if (!account) return alert("âŒ æ‰¾ä¸åˆ°ç™»å…¥å¸³è™Ÿ");

  const pw = prompt("è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼ä»¥åŒ¯å‡ºå¸³è™Ÿï¼š");
  if (!pw || sha256(pw) !== account.h) return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å‡º");

  const blob = new Blob([JSON.stringify([account], null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${account.u}-account.json`;
  a.click();
  URL.revokeObjectURL(url);
});
    

  </script>
</body>
</html>
