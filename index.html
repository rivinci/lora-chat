<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoRa Chat UI (å«å¸³è™Ÿ + ä¸»é¡Œé…è‰²)</title>
  <link rel="manifest" href="manifest.json" />
  <!-- js-sha256 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(console.error);
    }
  </script>
  <style>
    :root {
      --bg: #f0f4f8;         /* å…¨å±€èƒŒæ™¯ */
      --panel: #ffffff;       /* é¢æ¿(å¡ç‰‡/èŠå¤©æ¡†)é¡è‰² */
      --primary: #2a6f97;     /* æ–‡å­—ä¸»è‰² */
      --me: #d0f0fd;          /* æˆ‘æ–¹è¨Šæ¯æ³¡æ³¡ */
      --me-txt: #003f5c;
      --other: #e2e2e2;       /* ä»–æ–¹è¨Šæ¯æ³¡æ³¡ */
    }
    *{box-sizing:border-box;}
    body{font-family:"Segoe UI",sans-serif;margin:0;padding:10px;background:var(--bg);transition:background .3s ease;}
    h2{text-align:center;color:var(--primary);margin:.3em 0 .6em;user-select:none;}
    /* AUTH */
    #auth-area{max-width:420px;margin:0 auto 20px;background:var(--panel);padding:20px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:10px;}
    #auth-area input{padding:8px 12px;font-size:1em;}
    #auth-area button{padding:8px 12px;font-size:1em;cursor:pointer;}
    #auth-msg{text-align:center;font-size:.9em;color:#c00;min-height:1.2em;}
    /* MAIN UI */
    #main-ui{display:none;}
    #status{text-align:center;margin-bottom:5px;font-size:.9em;color:#333;}
    #top-bar{display:flex;flex-direction:column;gap:10px;align-items:center;margin-bottom:10px;}
    #chat-box{border:1px solid #ccc;padding:10px;height:50vh;overflow-y:scroll;background:var(--panel);margin-bottom:10px;display:flex;flex-direction:column;gap:5px;transition:background .3s ease;}
    .msg{max-width:70%;padding:8px 12px;border-radius:10px;font-size:1em;white-space:pre-wrap;word-wrap:break-word;}
    .me{align-self:flex-end;background:var(--me);color:var(--me-txt);} .other{align-self:flex-start;background:var(--other);color:#000;}
    #input-area{display:flex;gap:5px;} #msg-input{flex:1;padding:8px;font-size:1em;resize:vertical;min-height:4em;max-height:12em;overflow-y:auto;} #send-btn{padding:8px 12px;font-size:1em;cursor:pointer;} #send-btn::after{content:"ğŸ“¤";margin-left:6px;}
    #settings{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
    label{font-size:.9em;}
    #user-info{font-size:.9em;text-align:center;margin-top:2px;}
    #danger-zone{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
    #danger-zone button{background:#d9534f;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;}
  </style>
</head>
<body>
  <h2>LoRa Chat (Web UI)</h2>

  <!-- ===== AUTH AREA ===== -->
  <div id="auth-area">
    <input id="auth-username" type="text" placeholder="ä½¿ç”¨è€…åç¨±" autocomplete="username" />
    <input id="auth-password" type="password" placeholder="å¯†ç¢¼" autocomplete="current-password" />
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="login-btn">ç™»å…¥</button>
      <button id="register-btn">è¨»å†Š</button>
    </div>
    <div id="auth-msg"></div>
  </div>

  <!-- ===== MAIN UI ===== -->
  <div id="main-ui">
    <div id="top-bar">
      <div id="status">å°šæœªé€£æ¥è—ç‰™</div>
      <button id="connect-btn">é€£æ¥ BLE</button>
      <div id="settings">
        <label>ä¸»é¡Œï¼š
          <select id="theme-select">
            <option value="default" data-bg="#f0f4f8" data-panel="#ffffff">ç¶“å…¸æ·ºè‰²</option>
            <option value="dark"    data-bg="#1e1e1e" data-panel="#2d2d2d">æ·±è‰²</option>
            <option value="daisy"   data-bg="#fff9e6" data-panel="#ffffff">é››èŠæ·¡é»ƒ</option>
            <option value="sky"     data-bg="#e7f3ff" data-panel="#ffffff">å¤©ç©ºè—</option>
            <option value="mint"    data-bg="#eaf7ea" data-panel="#ffffff">è–„è·ç¶ </option>
          </select>
        </label>
        <label>è‡ªè¨‚èƒŒæ™¯ï¼š<input type="color" id="bg-color" value="#f0f4f8"></label>
        <label>å­—é«”ï¼š
          <select id="font-select">
            <option value="Segoe UI">Segoe UI</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="serif">Serif</option>
          </select>
        </label>
      </div>
    </div>

    <div id="chat-box"></div>

    <div id="input-area">
      <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="4"></textarea>
      <button id="send-btn">å‚³é€</button>
    </div>

    <div id="user-info"></div>
    <div id="danger-zone">
      <button id="delete-account-btn">ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ</button>
      <button id="logout-btn">ç™»å‡º</button>
    </div>
  </div>

  <script>
    /* ----------------- STORAGE KEYS ----------------- */
    const ACC_KEY="accounts",LOGIN_KEY="loggedInUser",HISTORY_KEY="lora-chat-history",INPUT_KEY="lora-chat-input",THEME_KEY="lora-chat-theme";

    /* ----------------- DOM ----------------- */
    const $=id=>document.getElementById(id);
    const authArea=$("auth-area"),usernameEl=$("auth-username"),passwordEl=$("auth-password"),loginBtn=$("login-btn"),registerBtn=$("register-btn"),authMsg=$("auth-msg");
    const mainUI=$("main-ui"),userInfo=$("user-info"),deleteBtn=$("delete-account-btn"),logoutBtn=$("logout-btn");
    const chatBox=$("chat-box"),sendBtn=$("send-btn"),connectBtn=$("connect-btn"),msgInput=$("msg-input"),statusText=$("status"),fontSelect=$("font-select"),bgColorPicker=$("bg-color"),themeSelect=$("theme-select");

    /* ----------------- Helper ----------------- */
    const hash=str=>sha256(str);
    const loadJson=(k,def)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(def));
    const saveJson=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const loadStr=k=>localStorage.getItem(k);
    const saveStr=(k,v)=>localStorage.setItem(k,v);

    /* ----------------- THEME HANDLING ----------------- */
    function applyTheme(themeId,bg,panel){
      document.documentElement.style.setProperty("--bg",bg);
      document.documentElement.style.setProperty("--panel",panel);
      chatBox.style.backgroundColor="var(--panel)"; // ensure chat box sync when switching back from custom color
      saveStr(THEME_KEY,themeId);
    }
    themeSelect.addEventListener("change",()=>{
      const opt=themeSelect.selectedOptions[0];
      applyTheme(opt.value,opt.dataset.bg,opt.dataset.panel);
      bgColorPicker.value=opt.dataset.panel; // åŒæ­¥é¡è‰²é¸å–å™¨ (ä»¥èŠå¤©æ¡†è‰²ç‚ºä¸»)
    });
    bgColorPicker.addEventListener("input",()=>{
      document.documentElement.style.setProperty("--panel",bgColorPicker.value);
      chatBox.style.backgroundColor="var(--panel)";
      themeSelect.value="custom";
    });

    /* ----------------- AUTH ----------------- */
    const loadAccounts=()=>loadJson(ACC_KEY,[]);
    const saveAccounts=arr=>saveJson(ACC_KEY,arr);
    const setLoggedIn=u=>u?saveStr(LOGIN_KEY,u):localStorage.removeItem(LOGIN_KEY);
    const getLoggedIn=()=>loadStr(LOGIN_KEY);

    function showAuth(msg=""){authArea.style.display="flex";mainUI.style.display="none";authMsg.textContent=msg;}
    function showMain(u){authArea.style.display="none";mainUI.style.display="block";userInfo.textContent=`ä½¿ç”¨è€…ï¼š${u}`;loadHistory();loadInput();}

    function register(){const u=usernameEl.value.trim(),p=passwordEl.value;if(!u||!p){authMsg.textContent="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";return;}const accs=loadAccounts();if(accs.some(a=>a.u===u)){authMsg.textContent="å¸³è™Ÿå·²å­˜åœ¨";return;}accs.push({u,h:hash(p)});saveAccounts(accs);authMsg.textContent="âœ… è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";usernameEl.value=passwordEl.value="";}
    function login(){const u=usernameEl.value.trim(),p=passwordEl.value;if(!u||!p){authMsg.textContent="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";return;}const accs=loadAccounts(),acc=accs.find(a=>a.u===u);if(!acc||acc.h!==hash(p)){authMsg.textContent="å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";return;}setLoggedIn(u);usernameEl.value=passwordEl.value="";showMain(u);}    
    function logout(){setLoggedIn(null);showAuth();}
    function deleteAccount(){if(!confirm("ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼Ÿæ­¤å‹•ä½œä¸å¯æ¢å¾©ï¼"))return;const u=getLoggedIn();saveAccounts(loadAccounts().filter(a=>a.u!==u));logout();}
    registerBtn.onclick=register;loginBtn.onclick=login;logoutBtn.onclick=logout;deleteBtn.onclick=deleteAccount;

    /* ----------------- CHAT ----------------- */
    function appendMsg(from,text){const div=document.createElement("div");div.className="msg "+(from==="ä½ "?"me":"other");div.textContent=text;chatBox.appendChild(div);chatBox.scrollTop=chatBox.scrollHeight;saveStr(HISTORY_KEY,chatBox.innerHTML);}    
    msgInput.addEventListener("input",()=>saveStr(INPUT_KEY,msgInput.value));
    function mockReply(m){setTimeout(()=>appendMsg("ESP32 (æ¨¡æ“¬)",`æ”¶åˆ°ã€Œ${m}ã€`),1e3);}    
    async function sendMessage(){const m=msgInput.value;if(!m.trim())return;appendMsg("ä½ ",m);msgInput.value="";saveStr(INPUT_KEY,"");if(window.bleCharacteristicTX){await bleCharacteristicTX.writeValue(new TextEncoder().encode(m));}else mockReply(m);}    
    sendBtn.onclick=sendMessage;msgInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey&&!/Mobi|Android/i.test(navigator.userAgent)){e.preventDefault();sendMessage();}});

    /* ----------------- BLE (åŸé‚è¼¯ç•¥) ----------------- */
    let bleDevice,bleServer,bleService,bleCharacteristicTX,bleCharacteristicRX,disconnectNotified=false;
    connectBtn.onclick=async()=>{try{bleDevice=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"ESP32"}],optionalServices:["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]});bleDevice.addEventListener("gattserverdisconnected",()=>{statusText.textContent="âŒ è—ç‰™å·²ä¸­æ–·";if(!disconnectNotified){appendMsg("ç³»çµ±","âš ï¸ è—ç‰™å·²ä¸­æ–·é€£ç·š");disconnectNotified=true;}});bleServer=await bleDevice.gatt.connect();bleService=await bleServer.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");bleCharacteristicTX=await bleService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");bleCharacteristicRX=await bleService.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");await bleCharacteristicRX.startNotifications();bleCharacteristicRX.addEventListener("characteristicvaluechanged",e=>appendMsg("ESP32",new TextDecoder().decode(e.target.value)));statusText.textContent="âœ… å·²é€£æ¥ ESP32 BLE";disconnectNotified=false;appendMsg("ç³»çµ±","âœ… å·²é€£æ¥ ESP32 BLE");}catch(err){console.error(err);statusText.textContent="âŒ è—ç‰™é€£ç·šå¤±æ•—";appendMsg("ç³»çµ±","âŒ BLE é€£ç·šå¤±æ•—");}};
    fontSelect.addEventListener("change",()=>{chatBox.style.fontFamily=msgInput.style.fontFamily=fontSelect.value;});

    /* ----------------- INIT ----------------- */
    (function(){const u=getLoggedIn();u?showMain(u):showAuth();const savedTheme=loadStr(THEME_KEY);if(savedTheme){themeSelect.value=savedTheme;themeSelect.dispatchEvent(new Event("change"));}})();
    function loadHistory(){const h=loadStr(HISTORY_KEY);if(h)chatBox.innerHTML=h;} function loadInput(){const t=loadStr(INPUT_KEY);if(t)msgInput.value=t;}
  </script>
</body>
</html>
