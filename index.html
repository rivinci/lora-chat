<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoRa Chat UI</title>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("✅ Service Worker 註冊成功"))
        .catch(err => console.error("❌ Service Worker 註冊失敗:", err));
    }
  </script>
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 10px; background-color: #f0f4f8; }
    h2 { text-align: center; color: #2a6f97; }
    #status { text-align: center; margin-bottom: 5px; font-size: 0.9em; color: #333; }
    #top-bar { display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 10px; }
    #top-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #chat-box {
      border: 1px solid #ccc;
      padding: 10px;
      height: 50vh;
      overflow-y: scroll;
      background: #ffffff;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .msg {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 1em;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .me {
      align-self: flex-end;
      background-color: #d0f0fd;
      color: #003f5c;
    }
    .other {
      align-self: flex-start;
      background-color: #e2e2e2;
      color: #000;
    }
    #input-area {
      display: flex;
      flex-direction: row;
      gap: 5px;
    }
    #msg-input {
      flex: 1;
      padding: 8px;
      font-size: 1em;
      resize: vertical;
      min-height: 4em;
      max-height: 12em;
      overflow-y: auto;
    }
    #send-btn {
      padding: 8px 12px;
      font-size: 1em;
    }
    #send-btn::after { content: "\1f4e4"; margin-left: 6px; }
    #settings {
      display: flex;
      flex-direction: row;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    label { font-size: 0.9em; }
  </style>
</head>
<body>
  <h2>LoRa Chat (Web UI)</h2>
  <div id="top-bar">
    <div id="status">尚未連接藍牙</div>
    <button id="connect-btn">連接 BLE</button>

    <div id="auth-controls" style="margin-top: 10px; text-align: center;">
      <button id="gen-key-btn">🔑 產生金鑰對</button>
      <button id="export-key-btn">⬇️ 匯出金鑰</button>
      <input type="file" id="import-key-file" style="display: none">
      <label style="margin-left: 10px;">
        <input type="checkbox" id="anon-mode"> 匿名模式
      </label>
      <label style="margin-left: 10px;">
        驗證模式：
        <select id="mode-select">
          <option value="full">每封驗簽</option>
          <option value="cache">快取模式</option>
          <option value="session">Session 模式</option>
        </select>
      </label>
    </div>

    <div id="settings">
      <label>選擇字體：
        <select id="font-select">
          <option value="Segoe UI">Segoe UI</option>
          <option value="Arial">Arial</option>
          <option value="Courier New">Courier New</option>
          <option value="Noto Sans TC">Noto Sans TC</option>
          <option value="serif">Serif</option>
        </select>
      </label>
      <label>背景顏色：<input type="color" id="bg-color" value="#ffffff"></label>
    </div>

    <div id="extras" style="margin-top: 10px; text-align: center;">
      <label>
        <input type="checkbox" id="debug-toggle"> 顯示封包原文
      </label>
      <label style="margin-left: 10px;">
        重送次數：
        <input type="number" id="retry-count" min="0" max="5" value="0" style="width: 40px;">
      </label>
      <button id="export-log-btn" style="margin-left: 10px;">⬇️ 匯出聊天紀錄</button>
    </div>

    <div id="stats" style="margin: 10px auto; text-align: center; font-size: 0.9em; color: #444;">
      已傳送：0｜成功：0｜失敗：0｜重送：0
    </div>
  </div>

  <div id="chat-box"></div>

  <div id="input-area">
    <textarea id="msg-input" placeholder="輸入訊息..." rows="4"></textarea>
    <button id="send-btn">傳送</button>
  </div>

  <script>
    // JavaScript 保留原樣（已實作）
  </script>
</body>
</html>
